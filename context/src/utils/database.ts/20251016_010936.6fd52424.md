---
timestamp: 'Thu Oct 16 2025 01:09:36 GMT-0400 (Eastern Daylight Time)'
content_id: 6fd524248b76b9bff416f9a64cb3add34199226385a31f85bc7e098d3066aea1
---

# file: src/utils/database.ts

```typescript
// This import loads the `.env` file as environment variables
import "jsr:@std/dotenv/load";
import { Db, MongoClient } from "npm:mongodb";
import { ID } from "@utils/types.ts";
import { generate } from "jsr:@std/uuid/unstable-v7";
import { parse } from "jsr:@std/csv"; // New import for CSV parsing

// --- New Interfaces for data models ---
interface InventoryItem {
  _id: ID;
  itemName: string;
  category: string;
  tags: string[];
  available: number;
  lastCheckout: Date | null;
  lastKerb: string | null;
}

interface User {
  _id: ID;
  kerb: string;
  first: string;
  last: string;
  role: string;
}
// --- End New Interfaces ---

async function initMongoClient() {
  const DB_CONN = Deno.env.get("MONGODB_URL");
  if (DB_CONN === undefined) {
    throw new Error("Could not find environment variable: MONGODB_URL");
  }
  const client = new MongoClient(DB_CONN);
  try {
    await client.connect();
  } catch (e) {
    throw new Error("MongoDB connection failed: " + e);
  }
  return client;
}

async function init() {
  const client = await initMongoClient();
  const DB_NAME = Deno.env.get("DB_NAME");
  if (DB_NAME === undefined) {
    throw new Error("Could not find environment variable: DB_NAME");
  }
  return [client, DB_NAME] as [MongoClient, string];
}

async function dropAllCollections(db: Db): Promise<void> {
  try {
    // Get all collection names
    const collections = await db.listCollections().toArray();

    // Drop each collection
    for (const collection of collections) {
      await db.collection(collection.name).drop();
    }
  } catch (error) {
    console.error("Error dropping collections:", error);
    throw error;
  }
}

/**
 * Populates the MongoDB database with initial inventory items and users from CSV files.
 * This function will drop existing 'items' and 'users' collections before inserting new data.
 * @param db The MongoDB Db instance to populate.
 */
export async function populateInitialData(db: Db): Promise<void> {
  console.log("Starting database population...");

  // Drop existing 'items' and 'users' collections to ensure a clean slate
  const collectionsToDrop = ["items", "users"];
  for (const collectionName of collectionsToDrop) {
    try {
      await db.collection(collectionName).drop();
      console.log(`Dropped '${collectionName}' collection.`);
    } catch (e) {
      // Ignore "collection not found" error, which means it didn't exist to begin with.
      if (e instanceof Error && e.message.includes("ns not found")) {
        console.log(
          `Collection '${collectionName}' did not exist, no need to drop.`,
        );
      } else {
        console.warn(`Error dropping '${collectionName}' collection:`, e);
      }
    }
  }

  // --- Populate Inventory Items from inventory.csv ---
  const inventoryCsvPath = "src/utils/inventory.csv"; // Path relative to project root
  try {
    const inventoryRaw = await Deno.readTextFile(inventoryCsvPath);
    const inventoryRecords = parse(inventoryRaw, {
      skipFirstRow: true, // Skip header row
      columns: [
        "ItemName",
        "Category",
        "Tags",
        "Available",
        "LastCheckout",
        "LastKerb",
      ],
    });

    const items: InventoryItem[] = inventoryRecords.map((record: any) => ({
      _id: freshID(),
      itemName: record.ItemName,
      category: record.Category,
      tags: record.Tags
        ? record.Tags.split(",").map((tag: string) => tag.trim()).filter(
          Boolean,
        )
        : [], // Split by comma, trim, and filter out empty strings
      available: parseInt(record.Available, 10), // Convert to number
      lastCheckout: record.LastCheckout ? new Date(record.LastCheckout) : null, // Convert to Date object, or null if empty
      lastKerb: record.LastKerb || null, // Use null if empty string
    }));

    if (items.length > 0) {
      await db.collection<InventoryItem>("items").insertMany(items);
      console.log(
        `Inserted ${items.length} inventory items into 'items' collection.`,
      );
    } else {
      console.log("No inventory items found in inventory.csv to insert.");
    }
  } catch (error) {
    console.error(
      `Failed to populate inventory from ${inventoryCsvPath}:`,
      error,
    );
  }

  // --- Populate Users from users.csv ---
  const usersCsvPath = "src/utils/users.csv"; // Path relative to project root
  try {
    const usersRaw = await Deno.readTextFile(usersCsvPath);
    const userRecords = parse(usersRaw, {
      skipFirstRow: true, // Skip header row
      columns: ["kerb", "first", "last", "role"],
    });

    const users: User[] = userRecords.map((record: any) => ({
      _id: freshID(),
      kerb: record.kerb,
      first: record.first,
      last: record.last,
      role: record.role,
    }));

    if (users.length > 0) {
      await db.collection<User>("users").insertMany(users);
      console.log(`Inserted ${users.length} users into 'users' collection.`);
    } else {
      console.log("No users found in users.csv to insert.");
    }
  } catch (error) {
    console.error(`Failed to populate users from ${usersCsvPath}:`, error);
  }

  console.log("Database population complete.");
}

/**
 * MongoDB database configured by .env
 * @returns {[Db, MongoClient]} initialized database and client
 */
export async function getDb() {
  const [client, DB_NAME] = await init();
  return [client.db(DB_NAME), client];
}

/**
 * Test database initialization
 * @returns {[Db, MongoClient]} initialized test database and client
 */
export async function testDb() {
  const [client, DB_NAME] = await init();
  const test_DB_NAME = `test-${DB_NAME}`;
  const test_Db = client.db(test_DB_NAME);
  await dropAllCollections(test_Db); // Clears all collections in the test DB
  return [test_Db, client] as [Db, MongoClient];
}

/**
 * Creates a fresh ID.
 * @returns {ID} UUID v7 generic ID.
 */
export function freshID() {
  return generate() as ID;
}

```
